<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
  <script type="text/javascript" src="libs/three.js"></script>
  <script type="text/javascript" src="libs/plugins/controls/OrbitControls.js"></script>
  <script type="text/javascript" src="libs/plugins/loaders/MTLLoader.js"></script>
  <script type="text/javascript" src="libs/plugins/loaders/OBJLoader.js"></script>
  <style type="text/css">
    html, body {
      width: 100%;
      height: 100%;
    }
    #tip {
      position: absolute;
      top: 10%;
      left: 10%;
      z-index: 1;
    }
  </style>
</head>
<body>
<div id="tip">
</div>
<script type="text/javascript">
  var container = document.createElement( 'div' );
  document.body.appendChild( container );

  var SCREEN_WIDTH = document.documentElement.clientWidth;
  var SCREEN_HEIGHT = document.documentElement.clientHeight;

  var scene = new THREE.Scene();

  var axisHelper = new THREE.AxisHelper( 1000 );
  scene.add( axisHelper );

  var camera = new THREE.PerspectiveCamera( 60, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 1200 );
  //var camera = new THREE.OrthographicCamera(-1000, 1000, 600, -600, 1, 2000);
  camera.position.set( 0, 130, 100 );
  //camera.lookAt(new THREE.Vector3(0, 150, -100));
  scene.add(camera);


  var renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setClearColor(0x000000);
  renderer.setPixelRatio( window.devicePixelRatio );
  renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
  container.appendChild( renderer.domElement );

  // CONTROLS
  cameraControls = new THREE.OrbitControls(camera, renderer.domElement);
  cameraControls.enableZoom = false;
  cameraControls.target = new THREE.Vector3(0, 150, 0);
  cameraControls.update();

  // Room
  var wallTexture = new THREE.TextureLoader().load('./assets/textures/wallpaper.jpg');
  wallTexture.wrapS = THREE.RepeatWrapping;
  wallTexture.wrapT = THREE.RepeatWrapping;
  wallTexture.minFilter = THREE.LinearMipMapLinearFilter;
  wallTexture.magFilter = THREE.LinearMipMapLinearFilter;
  wallTexture.repeat.set(3, 1);
  var room = new THREE.Mesh(new THREE.BoxGeometry(600, 300, 400), new THREE.MultiMaterial([
    new THREE.MeshPhongMaterial({
      map: wallTexture,
      depthWrite: false,
      side: THREE.BackSide
    }),
    new THREE.MeshPhongMaterial({
      map: wallTexture,
      depthWrite: false,
      side: THREE.BackSide
    }),
    new THREE.MeshPhongMaterial({
      color: 0xffffff,
      depthWrite: false,
      side: THREE.BackSide,
      emissive: 0xffffff,
      emissiveIntensity: 0.4
    }),
    new THREE.MeshPhongMaterial({
      color: 0xffffff,
      depthWrite: false,
      side: THREE.BackSide
    }),
    new THREE.MeshPhongMaterial({
      map: wallTexture,
      depthWrite: false,
      side: THREE.BackSide
    }),
    new THREE.MeshPhongMaterial({
      map: wallTexture,
      depthWrite: false,
      side: THREE.BackSide
    })
  ]));
  room.position.set(0, 150, 0);
  scene.add(room);

  var clock = new THREE.Clock();

  //plane
  var planeTexture = new THREE.TextureLoader().load('assets/textures/tile.jpg');
  planeTexture.wrapS = THREE.RepeatWrapping;
  planeTexture.wrapT = THREE.RepeatWrapping;
  planeTexture.repeat.set(10, 8);
  planeTexture.minFilter = THREE.LinearMipMapNearestFilter;
  planeTexture.magFilter = THREE.LinearFilter;
  var plane = new THREE.Mesh(new THREE.PlaneGeometry(600, 400, 1, 1), new THREE.MeshBasicMaterial({
    map: planeTexture
  }));
  plane.rotateX(-Math.PI/2);
  scene.add(plane);

  //Obj & Mtl
  var wood = new THREE.TextureLoader().load('assets/textures/WOOD.jpg');
  wood.wrapS = THREE.RepeatWrapping;
  wood.wrapT = THREE.RepeatWrapping;
  wood.repeat.set(1, 4);

  scene.obj = {};
  function loadMTLOBJ(name, posx, posy, posz, scale, rotY, callback) {
    var mtlLoader = new THREE.MTLLoader();
    mtlLoader.setPath('assets/models/obj/');
    mtlLoader.load(name + '.mtl', function(materials) {
      materials.preload();
      
      var objLoader = new THREE.OBJLoader();
      objLoader.setPath('assets/models/obj/');
      objLoader.setMaterials(materials);
      objLoader.load(name + '.obj', function(obj) {
        obj.rotateY(rotY);
        obj.scale.set(scale, scale, scale);
        obj.position.set(posx, posy, posz);
        scene.add(obj);
        scene.obj[name] = obj;
        if (callback) {
          callback(obj);
        }
      });
    });
  }

  loadMTLOBJ('door', 150, 0, 190, 3, 0, function(obj) {
    obj.children[4].material.map = wood;
  });

  loadMTLOBJ('sofa', -100, 0, 180, 1, Math.PI);

  loadMTLOBJ('table1', -50, 0, -180, 0.1, Math.PI);

  loadMTLOBJ('tv', -50, 50, -180, 0.18, 0, function(obj) {
    obj.children[0].material.color.set(0xdddddd);
    obj.children[1].material.color.set(0xffffff);
    obj.children[2].material.color.set(0x000000);
  });

  loadMTLOBJ('dinnertable', 200, 0, -80, 2, Math.PI/2, function(obj) {
    obj.children.forEach(function(child, i) {
      if (i !== 7) {
        child.material.color.set(0xffffff);
        child.material.map = wood;
      } else {
        child.material.color.set(0xcccccc);
      }
    })
  });

  loadMTLOBJ('plant', -260, 0, -180, 0.2, 0);

  loadMTLOBJ('pic', 290, 150, -80, 0.03, -Math.PI/2, function(obj) {
    obj.children[5].material.color.set(0xffffff);
    var flower = new THREE.TextureLoader().load('assets/textures/lily.jpg');
    flower.flipY = false;
    obj.children[5].material.map = flower;
  });

  loadMTLOBJ('window', -290, 100, 0, 0.1, -Math.PI/2, function(obj) {
    var view = new THREE.TextureLoader().load('assets/textures/view-out-window.jpg');
    view.wrapS = THREE.RepeatWrapping;
    view.wrapT = THREE.RepeatWrapping;
    var size = (new THREE.Box3().setFromObject(obj)).getSize();
    view.image.onload = function() {
      view.repeat.set(size.z / view.image.width, size.y / view.image.height);
    }
    obj.children[0].material.color.set(0xffffff);
    obj.children[0].material.map = view;
  });


  //Lights
  var amlight = new THREE.AmbientLight(0x505050);
  scene.add(amlight);
  var plight = new THREE.PointLight(0xffffff);
  plight.position.set(0, 280, 0);
  plight.distance = 600;
  plight.intensity = 0.9;
  plight.castShadow = true;
  scene.add(plight);
  var spPos = [
    new THREE.Vector3(-320, 320, -220),
    new THREE.Vector3(320, 320, -220),
    new THREE.Vector3(320, 320, 220),
    new THREE.Vector3(-320, 320, 220)
  ];
  spPos.forEach(function(pos) {
    var splight = new THREE.SpotLight(0xffffff);
    splight.position.set(pos.x, pos.y, pos.z);
    splight.target = plane;
    splight.intensity = 0.4;
    splight.distance = 700;
    splight.castShadow = true;
    scene.add(splight);
  });

  var frame;

  function animate() {
    frame = requestAnimationFrame( animate );
    render();
  }

  function render() {
    var delta = clock.getDelta();
    //cameraControls.update(delta);

    renderer.render(scene, camera);
  }

  animate();

  
</script>
</body>
</html>
